<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ask OncoSyNex AI</title>
  <style>
    :root{
      --bg:#0f2d6b; --bg-2:#0b2456; --ink:#0f1a2a; --panel:#ffffff; --line:#e6ebf4;
      --brand:#1e64ff; --brand-2:#06c6a0; --muted:#6b778e; --ink-inv:#fff;
      --shadow:0 16px 36px rgba(0,0,0,.28);
      --radius:16px; --radius-lg:20px; --radius-sm:12px;
      --edge: clamp(16px, 4vw, 96px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg, rgba(30,100,255,.10), rgba(255,255,255,0) 420px) var(--bg); color:var(--ink-inv)}

    /* Page shell (works as standalone /oncosynex/ai/ page) */
    header{ position:sticky; top:0; background:#ffffffd9; backdrop-filter:blur(8px); border-bottom:1px solid var(--line); color:#111; z-index:50 }
    header .wrap{ max-width:1100px; margin:0 auto; padding:10px var(--edge); display:flex; align-items:center; justify-content:space-between }
    header .brand{ display:flex; gap:10px; align-items:center; color:#1b2340; text-decoration:none; font-weight:900 }
    header .brand .logo{ width:28px; height:28px; border-radius:8px; background:#000 }

    main{ max-width:980px; margin: 22px auto; padding: 0 var(--edge) 32px }
    h1{ margin: 10px 0 12px; font-size: clamp(1.4rem, 1.2rem + 1.6vw, 2.2rem) }
    p.lead{ margin:0 0 18px; color:#d7e2fb; font-weight:700 }

    /* Chat container */
    .chat{ background:var(--panel); color:var(--ink); border:1px solid var(--line); border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow:hidden }
    .chat-head{ display:flex; gap:12px; align-items:center; padding:14px 16px; background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75)); border-bottom:1px solid var(--line) }
    .chat-head .dot{ width:10px; height:10px; border-radius:99px; background: #22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.16) }
    .chat-head h2{ margin:0; font-size:1rem }
    .tray{ margin-left:auto; display:flex; gap:10px }
    .tray button{ background:#f4f7ff; border:1px solid var(--line); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700 }

    .feed{ height:min(62vh, 560px); overflow:auto; padding:18px; background:linear-gradient(180deg, #f8fbff, #fff) }
    .msg{ display:flex; gap:12px; margin:10px 0; align-items:flex-start }
    .msg .bubble{ max-width: 70ch; padding:12px 14px; border-radius:14px; border:1px solid var(--line); box-shadow: 0 4px 10px rgba(0,0,0,.04) }
    .msg.user{ justify-content:flex-end }
    .msg.user .bubble{ background:#e8f0ff; border-color:#d8e5ff }
    .msg.bot .avatar{ width:28px; height:28px; border-radius:8px; background:var(--bg) }
    .msg.bot .bubble{ background:#fff }

    .suggest{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
    .chip{ background:#f2f6ff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:700; font-size:.9rem }
    .chip:hover{ background:#e8f0ff }

    .composer{ display:flex; gap:10px; padding:12px; border-top:1px solid var(--line); background:#fff }
    .composer input{ flex:1; border:1px solid var(--line); border-radius:12px; padding:12px 14px; font-size:1rem }
    .composer button{ background:var(--brand); color:#fff; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer }

    /* Floating widget variant (optional; include this file globally and add data-ai-launcher attribute to any element to open) */
    .ai-widget{ position:fixed; bottom:18px; right:18px; width: min(440px, 92vw); background:var(--panel); color:var(--ink); border:1px solid var(--line); border-radius: var(--radius-lg); box-shadow: var(--shadow); display:none; overflow:hidden; z-index: 120 }
    .ai-widget.open{ display:block }
    .ai-fab{ position:fixed; bottom:18px; right:18px; border-radius:999px; background:var(--brand); color:#fff; border:0; padding:14px 16px; font-weight:900; box-shadow: var(--shadow); cursor:pointer; z-index:110 }

    @media (max-width:520px){
      .msg .bubble{ max-width: 100% }
    }
  </style>
</head>
<body>
  <!-- Standalone page header (remove if embedding as widget only) -->
  <header>
    <div class="wrap">
      <a class="brand" href="/oncosynex/"><span class="logo"></span><span>OncoSyNex</span></a>
      <strong>Ask OncoSyNex AI</strong>
    </div>
  </header>

  <main>
    <h1>How can I help today?</h1>
    <p class="lead">Type a question or click a suggested one below. Answers come from your preloaded knowledge base—no external calls needed.</p>

    <div class="chat" id="chat">
      <div class="chat-head">
        <div class="dot" aria-hidden="true"></div>
        <h2>OncoSyNex AI (assistant)</h2>
        <div class="tray">
          <button id="reset">Reset</button>
          <button id="export">Export</button>
        </div>
      </div>
      <div class="feed" id="feed" aria-live="polite"></div>
      <div class="composer">
        <input id="prompt" type="text" placeholder="Ask about ImmunoAI, Bioinformatics Suite, pricing, samples…" autocomplete="off" />
        <button id="send">Send</button>
      </div>
    </div>
  </main>

  <!-- Optional floating button to open this chat as a widget (works on any page) -->
  <button class="ai-fab" id="aiFab" title="Ask OncoSyNex AI">Ask AI</button>
  <div class="ai-widget" id="aiWidget" role="dialog" aria-modal="true" aria-label="Ask OncoSyNex AI">
    <div class="chat">
      <div class="chat-head">
        <div class="dot" aria-hidden="true"></div>
        <h2>OncoSyNex AI</h2>
        <div class="tray">
          <button id="wReset">Reset</button>
          <button id="wClose">Close</button>
        </div>
      </div>
      <div class="feed" id="wFeed"></div>
      <div class="composer">
        <input id="wPrompt" type="text" placeholder="Ask a question…" />
        <button id="wSend">Send</button>
      </div>
    </div>
  </div>

  <script>
  /* ============================
     0) PRELOADED Q&A (EDIT THIS)
     ============================ */
  const PRELOADED_QA = [
    {
      id: 'immunoai-overview',
      q: 'What is the ImmunoAI Platform?',
      a: 'ImmunoAI is our AI-powered multi-omics platform for immunotherapy R&D. It integrates neoantigen discovery, epitope prediction, MHC binding, and in-silico validation pipelines, with audit-ready reporting.',
      tags: ['product','immunoai','platform'],
      keywords: ['immunoai','platform','neoantigen','mhc','prediction','multi-omics']
    },
    {
      id: 'bioinformatics-suite',
      q: 'What is included in the Bioinformatics Suite?',
      a: 'Our Bioinformatics Suite covers bulk RNA-seq, scRNA-seq, WES/WGS, HLA typing, variant annotation (VEP), and pVACseq-based neoantigen pipelines with containerized, reproducible workflows.',
      tags: ['product','bioinformatics'],
      keywords: ['rna-seq','scrna','wes','wgs','hla','vep','pvacseq','pipelines']
    },
    {
      id: 'antigens-catalog',
      q: 'Do you supply antigens and plasmids?',
      a: 'Yes. We provide a curated catalog of recombinant antigens and plasmids for diagnostics and immunotherapy research, with COA documentation and custom expression services.',
      tags: ['products','antigens','plasmids'],
      keywords: ['antigens','plasmids','catalog','recombinant']
    },
    {
      id: 'pricing',
      q: 'How does pricing work?',
      a: 'We offer tiered subscriptions for software (Starter, Pro, Enterprise) and per-project pricing for services. Contact us for an itemized quote or visit /oncosynex/pricing/.',
      tags: ['pricing'],
      keywords: ['pricing','cost','quote','subscription','enterprise']
    },
    {
      id: 'security',
      q: 'How do you handle data security and compliance?',
      a: 'We follow industry best practices with encrypted transit and at-rest, role-based access, audit logs, and configurable data retention. Compliance mappings are available on request.',
      tags: ['security'],
      keywords: ['security','privacy','compliance','encryption','audit']
    },
    {
      id: 'demo',
      q: 'Can I schedule a personalized demo?',
      a: 'Absolutely. Visit /oncosynex/contact/#demo to schedule a live walkthrough tailored to your workflows and datasets.',
      tags: ['demo'],
      keywords: ['demo','schedule','contact']
    }
  ];

  /* =================================================================
     1) LIGHTWEIGHT MATCHING (no libraries; works offline on GH Pages)
     ================================================================= */
  const normalize = (s) => s.toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
  const tokenize = (s) => normalize(s).split(' ').filter(Boolean);
  const jaccard = (a, b) => { // token overlap
    const A = new Set(a), B = new Set(b); const inter = [...A].filter(x => B.has(x)).length; const uni = new Set([...A,...B]).size; return uni ? inter/uni : 0;
  };
  function scoreQuery(query, item){
    const qTokens = tokenize(query);
    const titleTokens = tokenize(item.q + ' ' + (item.keywords||[]).join(' '));
    let score = jaccard(qTokens, titleTokens);
    // keyword boosts
    (item.keywords||[]).forEach(k => { if (normalize(query).includes(normalize(k))) score += 0.15; });
    // tag boosts for common intents
    if (/price|cost|rate|subscription/.test(query)) if (item.tags?.includes('pricing')) score += 0.2;
    if (/demo|trial|walkthrough|contact/.test(query)) if (item.tags?.includes('demo')) score += 0.2;
    if (/security|privacy|compliance|hipaa|gdpr/.test(query)) if (item.tags?.includes('security')) score += 0.2;
    return score;
  }
  function bestMatches(query, limit=3){
    return PRELOADED_QA.map(item => ({...item, _score: scoreQuery(query,item)}))
      .filter(x => x._score > 0)
      .sort((a,b) => b._score - a._score)
      .slice(0, limit);
  }

  /* =====================
     2) CHAT UI RENDERING
     ===================== */
  function el(html){ const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; }
  function renderMsg(feedEl, role, html){
    const node = el(`<div class="msg ${role}"><div class="avatar"></div><div class="bubble">${html}</div></div>`);
    feedEl.appendChild(node); feedEl.scrollTop = feedEl.scrollHeight; return node;
  }
  function renderSuggest(feedEl){
    const chips = PRELOADED_QA.slice(0,6).map(x => `<button class="chip" data-qid="${x.id}">${x.q}</button>`).join('');
    const node = renderMsg(feedEl, 'bot', `<strong>Popular questions</strong><div class="suggest">${chips}</div>`);
    node.querySelectorAll('.chip').forEach(btn => btn.addEventListener('click', () => {
      const q = PRELOADED_QA.find(x => x.id === btn.dataset.qid)?.q; if (q) ask(feedEl, q);
    }));
  }

  /* =====================
     3) ASK / ANSWER LOGIC
     ===================== */
  function answerFor(query){
    const matches = bestMatches(query, 3);
    if (!matches.length) return { kind: 'nohit', html: `I couldn’t find an exact match. Try rephrasing, or check <a href="/oncosynex/resources/platform/">platform resources</a> or <a href="/oncosynex/contact/#demo">schedule a demo</a>.` };
    if (matches[0]._score >= 0.55){
      return { kind: 'direct', html: matches[0].a + hintRelated(matches) };
    }
    // Show top matches as options if confidence is lower
    const opts = matches.map(m => `<li><button class="chip" data-qid="${m.id}">${m.q}</button></li>`).join('');
    return { kind: 'suggest', html: `Did you mean:<ul class="suggest" style="list-style:none;padding:0;margin:8px 0 0">${opts}</ul>` };
  }
  function hintRelated(list){
    const more = list.slice(1,3).map(x => `<button class="chip" data-qid="${x.id}">${x.q}</button>`).join('');
    return more ? `<div style="margin-top:10px"><em>Related:</em> ${more}</div>` : '';
  }

  async function ask(feedEl, text){
    const user = renderMsg(feedEl, 'user', escapeHtml(text));
    const bot = renderMsg(feedEl, 'bot', '…');
    await sleep(250); // small typing delay
    const ans = answerFor(text);
    bot.querySelector('.bubble').innerHTML = ans.html;
    bot.querySelectorAll('[data-qid]').forEach(btn => btn.addEventListener('click', () => {
      const q = PRELOADED_QA.find(x => x.id === btn.dataset.qid)?.q; if (q) ask(feedEl, q);
    }));
  }

  /* =====================
     4) WIRING: page chat + widget
     ===================== */
  function wireChat(feedId, promptId, sendId, resetId, intro=true){
    const feed = document.getElementById(feedId);
    const prompt = document.getElementById(promptId);
    const send = document.getElementById(sendId);
    const resetBtn = document.getElementById(resetId);

    const start = () => {
      feed.innerHTML = '';
      renderMsg(feed, 'bot', `Hi! I’m your OncoSyNex assistant. Ask me about <strong>ImmunoAI</strong>, <strong>Bioinformatics Suite</strong>, <strong>Antigens & plasmids</strong>, or <strong>pricing</strong>.`);
      renderSuggest(feed);
    };

    const submit = () => {
      const v = prompt.value.trim(); if (!v) return; prompt.value = '';
      ask(feed, v);
    };

    send?.addEventListener('click', submit);
    prompt?.addEventListener('keydown', (e) => { if (e.key === 'Enter') submit(); });
    resetBtn?.addEventListener('click', start);

    if (intro) start();
    return { feed, prompt };
  }

  function wireWidget(){
    const fab = document.getElementById('aiFab');
    const widget = document.getElementById('aiWidget');
    const open = () => { widget.classList.add('open'); if (!widget._wired){ wireChat('wFeed','wPrompt','wSend','wReset',true); widget._wired=true; } };
    const close = () => widget.classList.remove('open');
    fab?.addEventListener('click', open);
    document.getElementById('wClose')?.addEventListener('click', close);
    // Close on outside click
    document.addEventListener('click', (e) => { if (widget.classList.contains('open') && !e.target.closest('#aiWidget') && !e.target.closest('#aiFab')) close(); });
  }

  // Utilities
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const escapeHtml = (s) => s.replace(/[&<>"]\/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  // Boot both page chat and widget
  const { feed } = wireChat('feed','prompt','send','reset',true);
  wireWidget();

  // Export conversation (simple HTML download)
  document.getElementById('export')?.addEventListener('click', () => {
    const blob = new Blob([document.getElementById('feed').innerHTML], {type:'text/html'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'oncosynex-chat.html'; a.click();
  });
  </script>
</body>
</html>
